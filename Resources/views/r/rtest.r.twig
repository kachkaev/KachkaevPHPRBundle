start.time <- Sys.time()

if('RPostgreSQL' %in% rownames(installed.packages()) == FALSE) 
  install.packages('RPostgreSQL');
library(RPostgreSQL);

drv <- dbDriver("PostgreSQL")
con <- dbConnect(drv, dbname = "pr_data", user="postgres", password="hh");

items <- dbGetQuery(con, statement = paste(
  "SELECT id::bigint, user_id, time_taken::int, time_posted::int",
  "FROM photosets.londonflickr201307__items",
  "ORDER BY id"));


#rs <- dbSendQuery(con, "select * from photosets.londonflickr201307__items")   ## Submits a statement
#fetch(rs,n=-1)

#summary(items)
items$time_diff = items$time_posted - items$time_taken

#hist(items$time_diff)

items$day_posted = items$time_posted / 60 / 60 / 24
items$day_taken =  items$time_taken / 60 / 60 / 24
items$day_diff = items$day_posted - items$day_taken

hist(items$day_diff)

#summary(items)

items_part = subset(items, day_diff > quantile(items$day_diff, 0.025) & day_diff < quantile(items$day_diff, 0.975))
summary(items_part)
hist(items_part$day_diff, breaks = max(items_part$day_diff) - min (items_part$day_diff));


count95 = nrow(items_part);
count95_30days = nrow(subset(items_part,day_diff < 30));
count95_30days / count95

end.time <- Sys.time()
time.taken <- end.time - start.time
time.taken
